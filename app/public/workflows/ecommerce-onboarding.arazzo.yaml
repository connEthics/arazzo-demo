# ═══════════════════════════════════════════════════════════════════════════════
# E-Commerce Customer Onboarding - Arazzo 1.0.1 Advanced Example  
# ═══════════════════════════════════════════════════════════════════════════════
# This workflow demonstrates advanced Arazzo features for enterprise scenarios:
#   ✅ JSON Schema definitions for all requests/responses
#   ✅ 409 Conflict handling ("customer already exists" scenario)
#   ✅ Conditional branching with onSuccess/onFailure
#   ✅ Step skipping based on conditions
#   ✅ Retry logic with exponential backoff
#   ✅ Multi-system synchronization (Magento, Stripe, Salesforce)
# ═══════════════════════════════════════════════════════════════════════════════

arazzo: "1.0.1"

info:
  title: E-Commerce Customer Onboarding - Advanced
  version: "3.0.0"
  description: |
    **Enterprise-grade** customer onboarding workflow demonstrating:
    
    - Cross-system synchronization (**Magento** ↔ **Stripe** ↔ **Salesforce**)
    - Idempotent operations with *conflict resolution*
    - Comprehensive error handling and recovery
    
    ### Key Features
    - **Schema-driven**: All data models defined as reusable components
    - **Semantic linking**: Related attributes (email, name, phone) linked across schemas
    - **Error resilience**: 409 Conflict, rate limiting, validation errors handled

sourceDescriptions:
  - name: magentoApi
    url: https://magento.example.com/rest/default/schema
    type: openapi
    description: |
      **Adobe Commerce (Magento)** REST API for:
      - Customer management
      - Order processing
      - Product catalog
    
  - name: stripeApi
    url: https://raw.githubusercontent.com/stripe/openapi/master/openapi/spec3.yaml
    type: openapi
    description: |
      **Stripe Payment Gateway** API for:
      - Customer billing profiles
      - Payment methods
      - Subscriptions
    
  - name: salesforceApi
    url: https://developer.salesforce.com/docs/api-explorer/sobject/Contact
    type: openapi
    description: |
      **Salesforce CRM** REST API for:
      - Contact management
      - Lead tracking
      - Account associations

# ═══════════════════════════════════════════════════════════════════════════════
# REUSABLE COMPONENTS
# ═══════════════════════════════════════════════════════════════════════════════
components:
  schemas:
    # ─────────────────────────────────────────────────────────────────────────
    # Customer Request Schema
    # ─────────────────────────────────────────────────────────────────────────
    CustomerRequest:
      type: object
      required: [email, firstname, lastname]
      properties:
        email:
          type: string
          format: email
          maxLength: 255
          example: "john.doe@example.com"
        firstname:
          type: string
          minLength: 1
          maxLength: 100
          example: "John"
        lastname:
          type: string
          minLength: 1
          maxLength: 100
          example: "Doe"
        addresses:
          type: array
          items:
            type: object
            properties:
              telephone:
                type: string
                example: "+1-555-0123"
              street:
                type: array
                items:
                  type: string
                example: ["123 Main Street", "Apt 4B"]
              city:
                type: string
                example: "San Francisco"
              postcode:
                type: string
                example: "94102"
              country_id:
                type: string
                pattern: "^[A-Z]{2}$"
                example: "US"
              default_billing:
                type: boolean
              default_shipping:
                type: boolean
    
    # ─────────────────────────────────────────────────────────────────────────
    # Customer Response Schema
    # ─────────────────────────────────────────────────────────────────────────
    CustomerResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 12345
        email:
          type: string
          example: "john.doe@example.com"
        firstname:
          type: string
          example: "John"
        lastname:
          type: string
          example: "Doe"
        created_at:
          type: string
          format: date-time
          example: "2024-12-11T10:30:00Z"
        group_id:
          type: integer
          example: 1
        store_id:
          type: integer
          example: 1
    
    # ─────────────────────────────────────────────────────────────────────────
    # Stripe Customer Schema
    # ─────────────────────────────────────────────────────────────────────────
    StripeCustomer:
      type: object
      properties:
        id:
          type: string
          pattern: "^cus_[a-zA-Z0-9]+$"
          example: "cus_Nq1234567890"
        object:
          type: string
          const: customer
        email:
          type: string
          example: "john.doe@example.com"
        name:
          type: string
          example: "John Doe"
        phone:
          type: string
          example: "+1-555-0123"
        created:
          type: integer
          description: Unix timestamp
          example: 1702293000
        metadata:
          type: object
          additionalProperties:
            type: string
          example:
            magento_customer_id: "12345"
            source: "magento_sync"
    
    # ─────────────────────────────────────────────────────────────────────────
    # Error Schemas
    # ─────────────────────────────────────────────────────────────────────────
    MagentoError:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: "A customer with the same email address already exists"
        errors:
          type: array
          items:
            type: object
            properties:
              message:
                type: string
              parameters:
                type: array
                items:
                  type: string
        code:
          type: integer
          example: 409
    
    StripeError:
      type: object
      properties:
        error:
          type: object
          properties:
            type:
              type: string
              enum: [api_error, card_error, idempotency_error, invalid_request_error]
            code:
              type: string
              example: "customer_already_exists"
            message:
              type: string
              example: "Customer with email already exists"
            param:
              type: string
            doc_url:
              type: string

workflows:
  # ═══════════════════════════════════════════════════════════════════════════
  # WORKFLOW: Customer Onboarding with "Already Exists" Handling
  # ═══════════════════════════════════════════════════════════════════════════
  - workflowId: customer-onboarding-advanced
    summary: Customer Account Creation with 409 Conflict Handling
    description: |
      **Enterprise Customer Onboarding** - Creates customer across multiple systems:
      
      ### Key Capabilities
      - **409 Conflict handling**: Graceful recovery when customer already exists
      - **Conditional branching**: Skip creation if customer found in Magento
      - **Cross-system sync**: Consistent data across *Magento*, *Stripe*, and *Salesforce*
      - **Retry with backoff**: Automatic retry for rate-limited requests
      
      ### Data Flow
      1. Check if customer exists in **Magento** (primary source)
      2. Create/sync **Stripe** payment profile with linked `email` and `name`
      3. Create/sync **Salesforce** contact for CRM tracking
    
    inputs:
      type: object
      required: [email, firstName, lastName]
      properties:
        email:
          type: string
          format: email
          description: Customer email address (unique identifier)
          example: "john.doe@example.com"
        firstName:
          type: string
          minLength: 1
          maxLength: 100
          description: Customer first name
          example: "John"
        lastName:
          type: string
          minLength: 1
          maxLength: 100
          description: Customer last name
          example: "Doe"
        phone:
          type: string
          pattern: "^\\+?[1-9]\\d{1,14}$"
          description: Customer phone in E.164 format
          example: "+15550123456"
        company:
          type: string
          description: Company name (optional, for B2B)
        billingAddress:
          type: object
          required: [street, city, postcode, country_id]
          properties:
            street:
              type: string
              example: "123 Main Street"
            city:
              type: string
              example: "San Francisco"
            postcode:
              type: string
              example: "94102"
            country_id:
              type: string
              pattern: "^[A-Z]{2}$"
              example: "US"
        forceCreate:
          type: boolean
          default: false
          description: Force create even if partial records exist
        magentoAdminToken:
          type: string
          description: Magento admin API token
        stripeApiKey:
          type: string
          description: Stripe secret API key
        salesforceAccessToken:
          type: string
          description: Salesforce OAuth access token
          
    steps:
      # ─────────────────────────────────────────────────────────────────────────
      # STEP 1: Check if customer already exists in Magento
      # ─────────────────────────────────────────────────────────────────────────
      - stepId: checkExistingCustomer
        description: |
          **Pre-flight check** - Verifies if customer `email` exists in Magento.
          
          - Returns `total_count > 0` if customer found
          - Extracts existing `stripe_customer_id` from custom attributes
          - Triggers conditional branching via `onSuccess`
        operationId: magentoApi.searchCustomers
        parameters:
          - name: searchCriteria[filterGroups][0][filters][0][field]
            in: query
            value: email
          - name: searchCriteria[filterGroups][0][filters][0][value]
            in: query
            value: $inputs.email
          - name: searchCriteria[filterGroups][0][filters][0][conditionType]
            in: query
            value: eq
          - name: Authorization
            in: header
            value: Bearer $inputs.magentoAdminToken
        
        successCriteria:
          - condition: $statusCode == 200
        
        outputs:
          customerExists: $response.body.total_count > 0
          existingCustomerId: $response.body.items[0].id
          existingStripeId: $response.body.items[0].custom_attributes[?(@.attribute_code=='stripe_customer_id')].value
        
        # ⚡ Conditional branching: Skip creation if exists
        onSuccess:
          - name: customerFound
            type: goto
            stepId: syncExistingCustomer
            criteria:
              - condition: $response.body.total_count > 0
          - name: customerNotFound
            type: goto
            stepId: createMagentoCustomer
            criteria:
              - condition: $response.body.total_count == 0

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 2a: Create NEW customer in Magento
      # ─────────────────────────────────────────────────────────────────────────
      - stepId: createMagentoCustomer
        description: |
          **Create customer** in Adobe Commerce (Magento).
          
          Maps input fields to Magento customer model:
          - `email` → `customer.email`
          - `firstName` → `customer.firstname`
          - `lastName` → `customer.lastname`
          - `phone` → `addresses[0].telephone`
          
          *Handles 409 Conflict* by redirecting to `checkExistingCustomer`
        operationId: magentoApi.createCustomer
        requestBody:
          contentType: application/json
          payload:
            customer:
              email: $inputs.email
              firstname: $inputs.firstName
              lastname: $inputs.lastName
              addresses:
                - telephone: $inputs.phone
                  street: 
                    - $inputs.billingAddress.street
                  city: $inputs.billingAddress.city
                  postcode: $inputs.billingAddress.postcode
                  country_id: $inputs.billingAddress.country_id
                  default_billing: true
                  default_shipping: true
        parameters:
          - name: Authorization
            in: header
            value: Bearer $inputs.magentoAdminToken
        
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.body.id != null
        
        outputs:
          magentoCustomerId: $response.body.id
          magentoCreatedAt: $response.body.created_at
          customerGroupId: $response.body.group_id
          isNewCustomer: true
        
        # ⚡ onFailure: Handle 409 Conflict (customer exists - race condition)
        onFailure:
          - name: handleConflict409
            type: goto
            stepId: checkExistingCustomer
            criteria:
              - condition: $statusCode == 409
            outputs:
              retryReason: "Customer was created by another process"
          - name: handleValidation400
            type: goto
            stepId: handleValidationError
            criteria:
              - condition: $statusCode == 400
          - name: handleServerError
            type: end
            criteria:
              - condition: $statusCode >= 500

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 2b: Sync EXISTING customer (skip creation)
      # ─────────────────────────────────────────────────────────────────────────
      - stepId: syncExistingCustomer
        description: |
          **Retrieve existing customer** details for cross-system sync.
          
          Checks for existing integrations:
          - `stripe_customer_id` custom attribute
          - `salesforce_contact_id` custom attribute
          
          *Conditionally skips* Stripe creation if already synced.
        operationId: magentoApi.getCustomer
        parameters:
          - name: customerId
            in: path
            value: $steps.checkExistingCustomer.outputs.existingCustomerId
          - name: Authorization
            in: header
            value: Bearer $inputs.magentoAdminToken
        
        successCriteria:
          - condition: $statusCode == 200
        
        outputs:
          magentoCustomerId: $response.body.id
          magentoCreatedAt: $response.body.created_at
          customerGroupId: $response.body.group_id
          existingStripeId: $response.body.custom_attributes[?(@.attribute_code=='stripe_customer_id')].value
          existingSalesforceId: $response.body.custom_attributes[?(@.attribute_code=='salesforce_contact_id')].value
          isNewCustomer: false
        
        # ⚡ Check if Stripe sync needed
        onSuccess:
          - name: needsStripeSync
            type: goto
            stepId: createStripeCustomer
            criteria:
              - condition: $response.body.custom_attributes[?(@.attribute_code=='stripe_customer_id')].value == null
          - name: alreadySynced
            type: goto
            stepId: verifyExternalAccounts
            criteria:
              - condition: $response.body.custom_attributes[?(@.attribute_code=='stripe_customer_id')].value != null

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 3: Create Stripe Customer (with duplicate handling)
      # ─────────────────────────────────────────────────────────────────────────
      - stepId: createStripeCustomer
        description: |
          **Create Stripe customer** for payment processing.
          
          ### Field Mapping (semantic links)
          | Input | Stripe Field | Notes |
          |-------|--------------|-------|
          | `email` | `email` | Primary identifier |
          | `firstName` + `lastName` | `name` | Combined full name |
          | `phone` | `phone` | E.164 format |
          
          Uses **Idempotency-Key** to prevent duplicates.
        operationId: stripeApi.createCustomer
        requestBody:
          contentType: application/x-www-form-urlencoded
          payload:
            email: $inputs.email
            name: $inputs.firstName $inputs.lastName
            phone: $inputs.phone
            metadata[magento_customer_id]: $steps.createMagentoCustomer.outputs.magentoCustomerId
            metadata[source]: magento_sync
            metadata[created_by]: arazzo_workflow
            address[line1]: $inputs.billingAddress.street
            address[city]: $inputs.billingAddress.city
            address[postal_code]: $inputs.billingAddress.postcode
            address[country]: $inputs.billingAddress.country_id
        parameters:
          - name: Authorization
            in: header
            value: Bearer $inputs.stripeApiKey
          - name: Idempotency-Key
            in: header
            value: magento_$steps.createMagentoCustomer.outputs.magentoCustomerId
        
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.body.id != null
        
        outputs:
          stripeCustomerId: $response.body.id
          stripeCreatedAt: $response.body.created
          stripeObject: $response.body.object
        
        # ⚡ onFailure: Handle Stripe errors
        onFailure:
          - name: handleStripeConflict
            type: goto
            stepId: findExistingStripeCustomer
            criteria:
              - condition: $statusCode == 409
          - name: handleStripeRateLimit
            type: retry
            retryAfter: 1000
            retryLimit: 3
            criteria:
              - condition: $statusCode == 429
          - name: handleStripeError
            type: goto
            stepId: handleStripeError
            criteria:
              - condition: $statusCode == 400

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 3b: Find existing Stripe customer (fallback on conflict)
      # ─────────────────────────────────────────────────────────────────────────
      - stepId: findExistingStripeCustomer
        description: |
          **Fallback search** - Find existing Stripe customer by `email`.
          
          Used when:
          - 409 Conflict returned from `createStripeCustomer`
          - Idempotency key mismatch detected
          
          Returns first matching customer for linking.
        operationId: stripeApi.searchCustomers
        parameters:
          - name: query
            in: query
            value: email:'$inputs.email'
          - name: Authorization
            in: header
            value: Bearer $inputs.stripeApiKey
        
        successCriteria:
          - condition: $statusCode == 200
        
        outputs:
          stripeCustomerId: $response.body.data[0].id
          stripeCreatedAt: $response.body.data[0].created
          customerFoundInStripe: $response.body.data.length > 0

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 4: Create Salesforce Contact (with upsert logic)
      # ─────────────────────────────────────────────────────────────────────────
      - stepId: createSalesforceContact
        description: |
          **Upsert Salesforce Contact** - Create or update in CRM.
          
          ### Semantic Field Mapping
          - `email` → `Email` (external ID for upsert)
          - `firstName` → `FirstName`
          - `lastName` → `LastName`
          - `phone` → `Phone`
          
          **Cross-reference IDs** stored for data integrity:
          - `Magento_Customer_ID__c`
          - `Stripe_Customer_ID__c`
        operationId: salesforceApi.upsertContact
        parameters:
          - name: External_ID__c
            in: path
            value: $inputs.email
          - name: Authorization
            in: header
            value: Bearer $inputs.salesforceAccessToken
        requestBody:
          contentType: application/json
          payload:
            FirstName: $inputs.firstName
            LastName: $inputs.lastName
            Email: $inputs.email
            Phone: $inputs.phone
            Account:
              Name: $inputs.company
            MailingStreet: $inputs.billingAddress.street
            MailingCity: $inputs.billingAddress.city
            MailingPostalCode: $inputs.billingAddress.postcode
            MailingCountry: $inputs.billingAddress.country_id
            Magento_Customer_ID__c: $steps.createMagentoCustomer.outputs.magentoCustomerId
            Stripe_Customer_ID__c: $steps.createStripeCustomer.outputs.stripeCustomerId
            LeadSource: E-Commerce Website
            Customer_Status__c: Active
        
        # ✅ Accept both 200 (update) and 201 (create)
        successCriteria:
          - condition: $statusCode == 200 || $statusCode == 201
        
        outputs:
          salesforceContactId: $response.body.id
          salesforceSuccess: $response.body.success
          wasCreated: $statusCode == 201
          wasUpdated: $statusCode == 200
        
        onFailure:
          - name: handleSalesforceConflict
            type: goto
            stepId: updateExistingSalesforceContact
            criteria:
              - condition: $statusCode == 409

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 5: Update Magento with External IDs
      # ─────────────────────────────────────────────────────────────────────────
      - stepId: updateMagentoWithExternalIds
        description: |
          **Link external systems** - Update Magento with cross-references.
          
          Stores integration IDs as custom attributes:
          - `stripe_customer_id` → Stripe customer reference
          - `salesforce_contact_id` → Salesforce contact reference
          - `sync_status` → Set to *completed*
          
          Enables **bidirectional sync** and audit trail.
        operationId: magentoApi.updateCustomer
        parameters:
          - name: customerId
            in: path
            value: $steps.createMagentoCustomer.outputs.magentoCustomerId
          - name: Authorization
            in: header
            value: Bearer $inputs.magentoAdminToken
        requestBody:
          contentType: application/json
          payload:
            customer:
              id: $steps.createMagentoCustomer.outputs.magentoCustomerId
              custom_attributes:
                - attribute_code: stripe_customer_id
                  value: $steps.createStripeCustomer.outputs.stripeCustomerId
                - attribute_code: salesforce_contact_id
                  value: $steps.createSalesforceContact.outputs.salesforceContactId
                - attribute_code: sync_status
                  value: completed
                - attribute_code: last_sync_date
                  value: "2024-12-11T10:00:00Z"
        
        successCriteria:
          - condition: $statusCode == 200
        
        outputs:
          syncCompleted: true
          finalCustomerId: $response.body.id

      # ─────────────────────────────────────────────────────────────────────────
      # STEP 6: Verify all external accounts exist (for existing customers)
      # ─────────────────────────────────────────────────────────────────────────
      - stepId: verifyExternalAccounts
        description: |
          **Verification step** - Confirms Stripe and Salesforce accounts exist.
          
          Used for *existing customers* to validate integration state.
          Retrieves customer by `stripe_customer_id` stored in Magento.
        operationId: stripeApi.retrieveCustomer
        parameters:
          - name: customer
            in: path
            value: $steps.syncExistingCustomer.outputs.existingStripeId
          - name: Authorization
            in: header
            value: Bearer $inputs.stripeApiKey
        successCriteria:
          - condition: $statusCode == 200
        outputs:
          stripeVerified: true
          stripeCustomerId: $response.body.id

      # ─────────────────────────────────────────────────────────────────────────
      # ERROR HANDLERS
      # ─────────────────────────────────────────────────────────────────────────
      - stepId: handleValidationError
        description: |
          **Error handler** - Logs validation errors from Magento.
          
          Triggered by `400 Bad Request` responses, typically:
          - Invalid `email` format
          - Missing required fields (`firstname`, `lastname`)
          - Address validation failures
        operationId: magentoApi.logError
        requestBody:
          contentType: application/json
          payload:
            type: VALIDATION_ERROR
            source: customer_onboarding
            email: $inputs.email
            timestamp: "2024-12-11T10:00:00Z"
        successCriteria:
          - condition: $statusCode == 200
        outputs:
          errorLogged: true
          errorType: VALIDATION_ERROR

      - stepId: handleStripeError
        description: |
          **Stripe error handler** - Logs payment gateway errors.
          
          Common error scenarios:
          - Invalid API key format
          - Card declined events
          - Rate limiting (*429 responses*)
        operationId: magentoApi.logError
        requestBody:
          contentType: application/json
          payload:
            type: STRIPE_ERROR
            source: customer_onboarding
            magentoCustomerId: $steps.createMagentoCustomer.outputs.magentoCustomerId
            timestamp: "2024-12-11T10:00:00Z"
        successCriteria:
          - condition: $statusCode == 200
        outputs:
          errorLogged: true
          errorType: STRIPE_ERROR

      - stepId: updateExistingSalesforceContact
        description: |
          **Conflict resolution** - Updates existing Salesforce contact.
          
          Links Magento and Stripe IDs to pre-existing contact:
          - `Magento_Customer_ID__c` → Cross-system reference
          - `Stripe_Customer_ID__c` → Payment profile link
        operationId: salesforceApi.updateContact
        parameters:
          - name: contactId
            in: path
            value: $response.body.id
          - name: Authorization
            in: header
            value: Bearer $inputs.salesforceAccessToken
        requestBody:
          contentType: application/json
          payload:
            Magento_Customer_ID__c: $steps.createMagentoCustomer.outputs.magentoCustomerId
            Stripe_Customer_ID__c: $steps.createStripeCustomer.outputs.stripeCustomerId
        successCriteria:
          - condition: $statusCode == 200
        outputs:
          salesforceContactId: $response.body.id
          salesforceSuccess: true
          wasUpdated: true

    # ─────────────────────────────────────────────────────────────────────────
    # WORKFLOW OUTPUTS
    # ─────────────────────────────────────────────────────────────────────────
    outputs:
      magentoCustomerId: $steps.createMagentoCustomer.outputs.magentoCustomerId
      stripeCustomerId: $steps.createStripeCustomer.outputs.stripeCustomerId
      salesforceContactId: $steps.createSalesforceContact.outputs.salesforceContactId
      isNewCustomer: $steps.createMagentoCustomer.outputs.isNewCustomer
      syncCompleted: $steps.updateMagentoWithExternalIds.outputs.syncCompleted
      onboardingStatus: success
