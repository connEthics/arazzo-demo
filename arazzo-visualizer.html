<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arazzo Specification Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 1.1rem;
        }

        .input-section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .input-header h2 {
            font-size: 1.3rem;
            color: #00d9ff;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        textarea {
            width: 100%;
            height: 300px;
            background: #0d1117;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            color: #e0e0e0;
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 0.9rem;
            resize: vertical;
            line-height: 1.5;
        }

        textarea:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.2);
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 12px;
            width: fit-content;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }

        .tab:hover:not(.active) {
            color: #e0e0e0;
            background: rgba(255,255,255,0.1);
        }

        .visualization-section {
            display: none;
        }

        .visualization-section.active {
            display: block;
        }

        .viz-container {
            background: rgba(255,255,255,0.95);
            border-radius: 16px;
            padding: 30px;
            min-height: 500px;
            position: relative;
            overflow: auto;
        }

        .viz-container.dark {
            background: #1a1a2e;
        }

        #mermaid-diagram {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        #mermaid-diagram svg {
            max-width: 100%;
            height: auto;
        }

        .reactflow-container {
            height: 600px;
            background: #1a1a2e;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .rf-canvas {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .rf-node {
            position: absolute;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            border: 2px solid #4a5568;
            border-radius: 12px;
            padding: 15px 20px;
            min-width: 180px;
            cursor: move;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .rf-node:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 217, 255, 0.3);
            border-color: #00d9ff;
        }

        .rf-node.input-node {
            border-color: #48bb78;
            background: linear-gradient(135deg, #1a4731, #22543d);
        }

        .rf-node.output-node {
            border-color: #ed8936;
            background: linear-gradient(135deg, #7b341e, #9c4221);
        }

        .rf-node.step-node {
            border-color: #4299e1;
            background: linear-gradient(135deg, #1a365d, #2c5282);
        }

        .rf-node-header {
            font-weight: 700;
            font-size: 0.95rem;
            color: #fff;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rf-node-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            text-transform: uppercase;
        }

        .rf-node-content {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .rf-node-method {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-right: 5px;
        }

        .rf-node-method.get { background: #48bb78; color: #fff; }
        .rf-node-method.post { background: #4299e1; color: #fff; }
        .rf-node-method.put { background: #ed8936; color: #fff; }
        .rf-node-method.delete { background: #f56565; color: #fff; }

        .rf-edge {
            position: absolute;
            pointer-events: none;
        }

        .rf-edge path {
            fill: none;
            stroke: #4a5568;
            stroke-width: 2;
        }

        .rf-edge.animated path {
            stroke-dasharray: 5;
            animation: dash 0.5s linear infinite;
        }

        @keyframes dash {
            to { stroke-dashoffset: -10; }
        }

        .rf-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .rf-control-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .rf-control-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .info-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-panel h3 {
            color: #00d9ff;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .info-card-label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }

        .info-card-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e0e0e0;
        }

        .workflow-selector {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px 15px;
            color: #e0e0e0;
            font-size: 1rem;
            cursor: pointer;
            min-width: 200px;
        }

        .workflow-selector:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .error-message {
            background: rgba(245, 101, 101, 0.2);
            border: 1px solid #f56565;
            border-radius: 8px;
            padding: 15px;
            color: #feb2b2;
            margin-top: 15px;
        }

        .success-message {
            background: rgba(72, 187, 120, 0.2);
            border: 1px solid #48bb78;
            border-radius: 8px;
            padding: 15px;
            color: #9ae6b4;
            margin-top: 15px;
        }

        /* SVG Container for ReactFlow edges */
        .rf-edges-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .rf-nodes-container {
            position: relative;
            z-index: 1;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #a0aec0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color.input { background: #48bb78; }
        .legend-color.step { background: #4299e1; }
        .legend-color.output { background: #ed8936; }

        /* Data Flow View Styles */
        .dataflow-container {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 30px;
            min-height: 600px;
            overflow: auto;
        }

        .df-workflow-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .df-workflow-header h2 {
            color: #00d9ff;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .df-workflow-header p {
            color: #888;
            font-size: 0.9rem;
        }

        .df-steps-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .df-step-row {
            display: flex;
            align-items: stretch;
            gap: 20px;
            position: relative;
        }

        .df-step-card {
            flex: 1;
            background: linear-gradient(135deg, #1a365d, #2c5282);
            border: 2px solid #4299e1;
            border-radius: 12px;
            overflow: hidden;
            min-width: 300px;
        }

        .df-step-card.input-card {
            background: linear-gradient(135deg, #1a4731, #22543d);
            border-color: #48bb78;
        }

        .df-step-card.output-card {
            background: linear-gradient(135deg, #7b341e, #9c4221);
            border-color: #ed8936;
        }

        .df-step-header {
            background: rgba(0,0,0,0.3);
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .df-step-badge {
            font-size: 0.7rem;
            padding: 3px 10px;
            border-radius: 20px;
            background: #4299e1;
            color: #fff;
            font-weight: 700;
            text-transform: uppercase;
        }

        .df-step-card.input-card .df-step-badge { background: #48bb78; }
        .df-step-card.output-card .df-step-badge { background: #ed8936; }

        .df-step-title {
            font-weight: 700;
            color: #fff;
            font-size: 1rem;
        }

        .df-step-desc {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-left: auto;
        }

        .df-step-body {
            padding: 15px;
            display: flex;
            gap: 20px;
        }

        .df-fields-section {
            flex: 1;
        }

        .df-fields-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .df-fields-label::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .df-fields-label.inputs::before { background: #48bb78; }
        .df-fields-label.outputs::before { background: #ed8936; }
        .df-fields-label.params::before { background: #9f7aea; }

        .df-field {
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .df-field:hover {
            background: rgba(0,0,0,0.5);
            transform: translateX(3px);
        }

        .df-field.input-field { border-left-color: #48bb78; }
        .df-field.output-field { border-left-color: #ed8936; }
        .df-field.param-field { border-left-color: #9f7aea; }

        .df-field-name {
            color: #fff;
            font-weight: 600;
            font-family: 'Fira Code', monospace;
        }

        .df-field-value {
            color: #a0aec0;
            font-size: 0.8rem;
            margin-top: 3px;
            font-family: 'Fira Code', monospace;
            word-break: break-all;
        }

        .df-field-source {
            display: inline-block;
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .df-connections {
            position: relative;
            width: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .df-connection-line {
            width: 2px;
            flex: 1;
            background: linear-gradient(180deg, #4299e1, #48bb78);
            position: relative;
        }

        .df-connection-arrow {
            color: #4299e1;
            font-size: 1.5rem;
        }

        /* SVG Connections for Data Flow */
        .df-svg-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .df-link-line {
            fill: none;
            stroke-width: 2;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .df-link-line:hover {
            opacity: 1;
            stroke-width: 3;
        }

        .df-link-line.from-input { stroke: #48bb78; }
        .df-link-line.from-step { stroke: #00d9ff; }

        .df-data-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 217, 255, 0.15);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.7rem;
            color: #00d9ff;
            margin: 2px;
        }

        .df-data-pill.linked {
            background: rgba(72, 187, 120, 0.15);
            border-color: rgba(72, 187, 120, 0.3);
            color: #48bb78;
            cursor: pointer;
        }

        .df-data-pill.linked:hover {
            background: rgba(72, 187, 120, 0.3);
        }

        .df-divider {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .df-divider::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #4299e1 0%, #48bb78 100%);
        }

        .df-divider-icon {
            background: #1a1a2e;
            color: #4299e1;
            padding: 5px;
            border-radius: 50%;
            z-index: 1;
            font-size: 1.2rem;
        }

        .df-expression-highlight {
            background: rgba(159, 122, 234, 0.2);
            color: #d6bcfa;
            padding: 1px 4px;
            border-radius: 3px;
            font-family: 'Fira Code', monospace;
        }

        .df-legend {
            display: flex;
            gap: 25px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .df-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #a0aec0;
        }

        .df-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .df-legend-line {
            width: 30px;
            height: 3px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ­ Arazzo Specification Visualizer</h1>
            <p>Visualize your API workflow orchestration with Mermaid and React Flow</p>
        </header>

        <div class="input-section">
            <div class="input-header">
                <h2>ğŸ“„ Arazzo Specification (YAML/JSON)</h2>
                <div class="btn-group">
                    <button class="btn-secondary" onclick="loadExample()">ğŸ¾ Pet Store (Advanced)</button>
                    <button class="btn-secondary" onclick="loadEcommerceExample()">ğŸ›’ E-Commerce (409 Handling)</button>
                    <button class="btn-secondary" onclick="clearInput()">Clear</button>
                    <button class="btn-primary" onclick="visualize()">ğŸš€ Visualize</button>
                </div>
            </div>
            <textarea id="arazzo-input" placeholder="Paste your Arazzo specification here (YAML or JSON)...

Features demonstrated in examples:
âœ… JSON Schema definitions for requests/responses
âœ… Concrete payload examples  
âœ… Error handling (200/400/409 cases)
âœ… Conditional branching (onSuccess, onFailure)
âœ… Step skipping for 'customer already exists' scenario
âœ… Retry logic with retryAfter/retryLimit"></textarea>
            <div id="message-container"></div>
        </div>

        <div id="visualization-wrapper" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('mermaid')">ğŸ“Š Mermaid Flowchart</button>
                    <button class="tab" onclick="switchTab('reactflow')">ğŸ”€ Interactive Flow</button>
                    <button class="tab" onclick="switchTab('dataflow')">ğŸ”— Data Flow Details</button>
                </div>
                <div>
                    <label style="color: #888; margin-right: 10px;">Workflow:</label>
                    <select class="workflow-selector" id="workflow-selector" onchange="selectWorkflow()">
                    </select>
                </div>
            </div>

            <div id="mermaid-section" class="visualization-section active">
                <div class="viz-container">
                    <div id="mermaid-diagram"></div>
                </div>
            </div>

            <div id="reactflow-section" class="visualization-section">
                <div class="legend">
                    <div class="legend-item"><div class="legend-color input"></div> Input</div>
                    <div class="legend-item"><div class="legend-color step"></div> Step</div>
                    <div class="legend-item"><div class="legend-color output"></div> Output</div>
                </div>
                <div class="reactflow-container">
                    <div class="rf-canvas" id="rf-canvas">
                        <svg class="rf-edges-svg" id="rf-edges"></svg>
                        <div class="rf-nodes-container" id="rf-nodes"></div>
                    </div>
                    <div class="rf-controls">
                        <button class="rf-control-btn" onclick="zoomIn()" title="Zoom In">+</button>
                        <button class="rf-control-btn" onclick="zoomOut()" title="Zoom Out">âˆ’</button>
                        <button class="rf-control-btn" onclick="resetView()" title="Reset View">âŸ²</button>
                    </div>
                </div>
            </div>

            <div id="dataflow-section" class="visualization-section">
                <div class="dataflow-container" id="dataflow-container">
                    <!-- Generated by generateDataFlowView() -->
                </div>
            </div>

            <div class="info-panel" id="info-panel">
                <h3>ğŸ“‹ Specification Info</h3>
                <div class="info-grid" id="info-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                primaryColor: '#4299e1',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2c5282',
                lineColor: '#4a5568',
                secondaryColor: '#48bb78',
                tertiaryColor: '#ed8936',
                background: '#1a1a2e',
                mainBkg: '#2d3748',
                nodeBorder: '#4a5568',
                clusterBkg: '#1a202c',
                titleColor: '#e0e0e0',
                edgeLabelBackground: '#2d3748'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            }
        });

        let currentSpec = null;
        let currentWorkflow = null;
        let scale = 1;
        let translateX = 0;
        let translateY = 0;

        // Example Arazzo specification - Pet Store with Advanced Features
        const exampleSpec = `arazzo: "1.0.1"
info:
  title: Pet Adoption Workflow - Advanced
  version: "2.0.0"
  description: |
    A comprehensive workflow demonstrating advanced Arazzo features:
    - JSON Schema definitions for requests/responses
    - Concrete payload examples
    - Error handling (200/400/409 cases)
    - Conditional branching (onSuccess, onFailure)
    - Step skipping for "customer already exists" scenario

sourceDescriptions:
  - name: petStoreApi
    url: ./openapi/petstore.yaml
    type: openapi

# Reusable components for schemas and examples
components:
  inputs:
    LoginCredentials:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
        password:
          type: string
          minLength: 8
          format: password

  schemas:
    LoginResponse:
      type: object
      properties:
        token:
          type: string
          format: jwt
        expiresIn:
          type: integer
        user:
          type: object
          properties:
            id:
              type: integer
            username:
              type: string
            email:
              type: string
              format: email
    
    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: integer
        message:
          type: string
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              error:
                type: string
    
    Pet:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        category:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        status:
          type: string
          enum: [available, pending, sold]
        price:
          type: number
          format: decimal
        tags:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              name:
                type: string
    
    OrderRequest:
      type: object
      required: [petId, quantity]
      properties:
        petId:
          type: integer
          format: int64
        quantity:
          type: integer
          minimum: 1
          maximum: 10
        couponCode:
          type: string
          pattern: "^[A-Z0-9]{6,10}\$"
        shipDate:
          type: string
          format: date-time
        status:
          type: string
          enum: [placed, approved, delivered]
          default: placed
        complete:
          type: boolean
          default: false
    
    OrderResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        petId:
          type: integer
        quantity:
          type: integer
        originalPrice:
          type: number
        discountApplied:
          type: number
        totalPrice:
          type: number
        status:
          type: string
        shipDate:
          type: string
          format: date-time

workflows:
  - workflowId: adopt-pet-with-error-handling
    summary: Complete pet adoption with comprehensive error handling
    description: |
      Demonstrates full workflow with:
      âœ… Authentication with 401 error handling
      âœ… Pet search with empty results handling  
      âœ… Order placement with 409 conflict (pet already sold)
      âœ… Conditional branching based on coupon availability
      âœ… Step skip when coupon not needed
    
    inputs:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          description: User's login username
        password:
          type: string
          description: User's login password
        preferredStatus:
          type: string
          enum: [available, pending]
          default: available
          description: Pet availability status to filter
        preferredCategory:
          type: string
          enum: [Dogs, Cats, Birds, Fish]
          description: Optional category filter
        quantity:
          type: integer
          minimum: 1
          maximum: 5
          default: 1
        applyCoupon:
          type: boolean
          default: true
          description: Whether to attempt to apply a discount coupon
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 1: Authentication with full error handling
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: login
        description: Authenticate user and get access token
        operationId: petStoreApi.loginUser
        parameters:
          - name: username
            in: query
            value: \$inputs.username
          - name: password
            in: query
            value: \$inputs.password
        
        # âœ… Success criteria with multiple conditions
        successCriteria:
          - condition: \$statusCode == 200
          - condition: \$response.body.token != null
          - context: \$response.body
            type: jsonpath
            condition: \$.expiresIn > 0
        
        outputs:
          authToken: \$response.body.token
          userId: \$response.body.user.id
          tokenExpiry: \$response.body.expiresIn
        
        # âš¡ onFailure: Handle authentication errors
        onFailure:
          - name: handleAuthError
            type: end
            workflowId: adopt-pet-with-error-handling
            criteria:
              - condition: \$statusCode == 401
            outputs:
              error: "Authentication failed - invalid credentials"
              errorCode: AUTH_FAILED
          - name: handleValidationError
            type: goto
            stepId: endWithError
            criteria:
              - condition: \$statusCode == 400
            outputs:
              error: \$response.body.message
              errorCode: VALIDATION_ERROR

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 2: Find available pets with empty results handling
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: findAvailablePets
        description: Search for pets with the preferred status
        operationId: petStoreApi.findPetsByStatus
        parameters:
          - name: status
            in: query
            value: \$inputs.preferredStatus
          - name: Authorization
            in: header
            value: Bearer \$steps.login.outputs.authToken
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          selectedPetId: \$response.body[0].id
          selectedPetName: \$response.body[0].name
          selectedPetPrice: \$response.body[0].price
          petsFound: \$response.body.length
        
        # âš¡ onSuccess: Different paths based on results
        onSuccess:
          - name: petsFound
            type: goto
            stepId: getPetDetails
            criteria:
              - condition: \$response.body.length > 0
          - name: noPetsFound
            type: goto
            stepId: handleNoPets
            criteria:
              - condition: \$response.body.length == 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 2b: Handle no pets available (alternative branch)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: handleNoPets
        description: Handle case when no pets are available
        operationId: petStoreApi.getRecommendations
        parameters:
          - name: Authorization
            in: header
            value: Bearer \$steps.login.outputs.authToken
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          recommendation: "No pets currently available. Check back soon!"
          alternativeCategories: \$response.body.categories
        onSuccess:
          - name: endNoStock
            type: end
            criteria:
              - condition: \$statusCode == 200

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 3: Get pet details with 404 retry logic
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: getPetDetails
        description: Get detailed information about the selected pet
        operationId: petStoreApi.getPetById
        parameters:
          - name: petId
            in: path
            value: \$steps.findAvailablePets.outputs.selectedPetId
          - name: Authorization
            in: header
            value: Bearer \$steps.login.outputs.authToken
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          petPrice: \$response.body.price
          petCategory: \$response.body.category.name
          petDescription: \$response.body.description
          petPhotos: \$response.body.photoUrls
        
        # âš¡ onFailure: Retry search if pet not found (404)
        onFailure:
          - name: petNotFound
            type: goto
            stepId: findAvailablePets
            criteria:
              - condition: \$statusCode == 404

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 4: Check coupon eligibility (SKIPPABLE)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: checkCouponEligibility
        description: Check if user wants coupon and if coupons available
        # âš¡ SKIP CONDITION: Skip this step if user doesn't want coupon
        x-]skip: \$inputs.applyCoupon == false
        operationId: petStoreApi.getPetCoupons
        parameters:
          - name: petId
            in: path
            value: \$steps.findAvailablePets.outputs.selectedPetId
          - name: categoryId
            in: query
            value: \$steps.getPetDetails.outputs.petCategory
          - name: Authorization
            in: header
            value: Bearer \$steps.login.outputs.authToken
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          hasCoupons: \$response.body.coupons.length > 0
          bestCouponCode: \$response.body.coupons[0].code
          discountPercent: \$response.body.coupons[0].discountPercent
        
        # âš¡ Conditional branching based on coupon availability
        onSuccess:
          - name: couponFound
            type: goto
            stepId: placeOrderWithCoupon
            criteria:
              - condition: \$response.body.coupons.length > 0
          - name: noCouponAvailable
            type: goto
            stepId: placeOrderWithoutCoupon
            criteria:
              - condition: \$response.body.coupons.length == 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 5a: Place order WITH coupon
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: placeOrderWithCoupon
        description: Place the adoption order with coupon applied
        operationId: petStoreApi.placeOrder
        requestBody:
          contentType: application/json
          payload:
            petId: \$steps.findAvailablePets.outputs.selectedPetId
            quantity: \$inputs.quantity
            couponCode: \$steps.checkCouponEligibility.outputs.bestCouponCode
            shipDate: "2024-12-25T10:00:00Z"
            status: placed
            complete: false
        parameters:
          - name: Authorization
            in: header
            value: Bearer \$steps.login.outputs.authToken
        
        successCriteria:
          - condition: \$statusCode == 200
          - condition: \$response.body.id != null
        
        outputs:
          orderId: \$response.body.id
          finalPrice: \$response.body.totalPrice
          discountApplied: \$response.body.discountApplied
          orderStatus: \$response.body.status
        
        # âš¡ onFailure: Handle 409 Conflict (pet already sold)
        onFailure:
          - name: handlePetSold
            type: goto
            stepId: findAvailablePets
            criteria:
              - condition: \$statusCode == 409
            outputs:
              retryReason: "Pet was sold, searching for alternatives"
          - name: handleValidation
            type: goto
            stepId: endWithError
            criteria:
              - condition: \$statusCode == 400
        
        onSuccess:
          - name: orderComplete
            type: goto
            stepId: sendConfirmation
            criteria:
              - condition: \$statusCode == 200

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 5b: Place order WITHOUT coupon
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: placeOrderWithoutCoupon
        description: Place adoption order without any coupon
        operationId: petStoreApi.placeOrder
        requestBody:
          contentType: application/json
          payload:
            petId: \$steps.findAvailablePets.outputs.selectedPetId
            quantity: \$inputs.quantity
            shipDate: "2024-12-25T10:00:00Z"
            status: placed
            complete: false
        parameters:
          - name: Authorization
            in: header
            value: Bearer \$steps.login.outputs.authToken
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          orderId: \$response.body.id
          finalPrice: \$response.body.totalPrice
          discountApplied: 0
          orderStatus: \$response.body.status
        
        # âš¡ onFailure: Handle 409 Conflict
        onFailure:
          - name: handlePetSold
            type: goto
            stepId: findAvailablePets
            criteria:
              - condition: \$statusCode == 409
        
        onSuccess:
          - name: orderComplete
            type: goto
            stepId: sendConfirmation
            criteria:
              - condition: \$statusCode == 200

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 6: Send confirmation notification
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: sendConfirmation
        description: Send order confirmation to the user
        operationId: petStoreApi.sendNotification
        requestBody:
          contentType: application/json
          payload:
            userId: \$steps.login.outputs.userId
            type: order_confirmation
            orderId: \$steps.placeOrderWithCoupon.outputs.orderId
            petName: \$steps.findAvailablePets.outputs.selectedPetName
            message: "Your adoption order has been confirmed!"
        parameters:
          - name: Authorization
            in: header
            value: Bearer \$steps.login.outputs.authToken
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          notificationSent: true
          confirmationId: \$response.body.id

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ERROR HANDLER: End workflow with error
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: endWithError
        description: End workflow with error details
        operationId: petStoreApi.logError
        requestBody:
          contentType: application/json
          payload:
            errorCode: \$steps.login.outputs.errorCode
            errorMessage: \$steps.login.outputs.error
            timestamp: "2024-12-11T10:00:00Z"
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          logged: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # WORKFLOW OUTPUTS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    outputs:
      orderId: \$steps.placeOrderWithCoupon.outputs.orderId
      petName: \$steps.findAvailablePets.outputs.selectedPetName
      originalPrice: \$steps.getPetDetails.outputs.petPrice
      finalPrice: \$steps.placeOrderWithCoupon.outputs.finalPrice
      discountApplied: \$steps.placeOrderWithCoupon.outputs.discountApplied
      orderStatus: \$steps.placeOrderWithCoupon.outputs.orderStatus
      couponUsed: \$steps.checkCouponEligibility.outputs.bestCouponCode

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WORKFLOW 2: Simple pet search
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - workflowId: quick-pet-search
    summary: Simple pet lookup with minimal error handling
    description: Basic workflow to search for available pets
    inputs:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
        password:
          type: string
        category:
          type: string
          enum: [Dogs, Cats, Birds]
    steps:
      - stepId: authenticate
        description: Login to the system
        operationId: petStoreApi.loginUser
        parameters:
          - name: username
            in: query
            value: \$inputs.username
          - name: password
            in: query
            value: \$inputs.password
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          token: \$response.body.token
        onFailure:
          - name: authFailed
            type: end
            criteria:
              - condition: \$statusCode != 200

      - stepId: listPets
        description: Get all available pets
        operationId: petStoreApi.findPetsByStatus
        parameters:
          - name: status
            in: query
            value: available
          - name: Authorization
            in: header
            value: Bearer \$steps.authenticate.outputs.token
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          pets: \$response.body
          petCount: \$response.body.length

    outputs:
      availablePets: \$steps.listPets.outputs.pets
      totalFound: \$steps.listPets.outputs.petCount`;

        // E-Commerce Example: Magento + Stripe + Salesforce - Advanced with Error Handling
        const ecommerceExampleSpec = `arazzo: "1.0.1"
info:
  title: E-Commerce Integration Workflows - Advanced
  version: "3.0.0"
  description: |
    Complete e-commerce integration workflows demonstrating:
    âœ… JSON Schema definitions for all requests/responses
    âœ… Concrete payload examples
    âœ… Error handling (200/400/409 cases)  
    âœ… Conditional branching (onSuccess, onFailure)
    âœ… Step skipping for "customer already exists" scenario

sourceDescriptions:
  - name: magentoApi
    url: https://magento.example.com/rest/default/schema
    type: openapi
    description: Adobe Commerce (Magento) REST API
    
  - name: stripeApi
    url: https://raw.githubusercontent.com/stripe/openapi/master/openapi/spec3.yaml
    type: openapi
    description: Stripe Payment Gateway API
    
  - name: salesforceApi
    url: https://developer.salesforce.com/docs/api-explorer/sobject/Contact
    type: openapi
    description: Salesforce CRM REST API

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# REUSABLE COMPONENTS: Schemas and Examples
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
components:
  schemas:
    # Customer Request Schema
    CustomerRequest:
      type: object
      required: [email, firstname, lastname]
      properties:
        email:
          type: string
          format: email
          maxLength: 255
        firstname:
          type: string
          minLength: 1
          maxLength: 100
        lastname:
          type: string
          minLength: 1
          maxLength: 100
        addresses:
          type: array
          items:
            type: object
            properties:
              telephone:
                type: string
              street:
                type: array
                items:
                  type: string
              city:
                type: string
              postcode:
                type: string
              country_id:
                type: string
                pattern: "^[A-Z]{2}\$"
              default_billing:
                type: boolean
              default_shipping:
                type: boolean
    
    # Customer Response Schema
    CustomerResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
        firstname:
          type: string
        lastname:
          type: string
        created_at:
          type: string
          format: date-time
        group_id:
          type: integer
        store_id:
          type: integer
    
    # Stripe Customer Schema
    StripeCustomer:
      type: object
      properties:
        id:
          type: string
          pattern: "^cus_[a-zA-Z0-9]+\$"
        object:
          type: string
          const: customer
        email:
          type: string
        name:
          type: string
        phone:
          type: string
        created:
          type: integer
        metadata:
          type: object
          additionalProperties:
            type: string
    
    # Error Schemas
    MagentoError:
      type: object
      required: [message]
      properties:
        message:
          type: string
        errors:
          type: array
          items:
            type: object
            properties:
              message:
                type: string
              parameters:
                type: array
                items:
                  type: string
        code:
          type: integer
        trace:
          type: string
    
    StripeError:
      type: object
      properties:
        error:
          type: object
          properties:
            type:
              type: string
              enum: [api_error, card_error, idempotency_error, invalid_request_error]
            code:
              type: string
            message:
              type: string
            param:
              type: string
            doc_url:
              type: string

workflows:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WORKFLOW 1: Customer Onboarding with "Already Exists" Handling
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - workflowId: customer-onboarding-advanced
    summary: Customer Account Creation with Conflict Handling
    description: |
      Creates customer across Magento, Stripe, and Salesforce with:
      âš¡ 409 Conflict handling when customer already exists
      âš¡ Skip step if customer found in Magento
      âš¡ Conditional sync based on existing accounts
    
    inputs:
      type: object
      required: [email, firstName, lastName]
      properties:
        email:
          type: string
          format: email
          description: Customer email address (unique identifier)
        firstName:
          type: string
          minLength: 1
          maxLength: 100
          description: Customer first name
        lastName:
          type: string
          minLength: 1
          maxLength: 100
          description: Customer last name
        phone:
          type: string
          pattern: "^\\\\+?[1-9]\\\\d{1,14}\$"
          description: Customer phone in E.164 format
        company:
          type: string
          description: Company name (optional, for B2B)
        billingAddress:
          type: object
          required: [street, city, postcode, country_id]
          properties:
            street:
              type: string
            city:
              type: string
            postcode:
              type: string
            country_id:
              type: string
              pattern: "^[A-Z]{2}\$"
        forceCreate:
          type: boolean
          default: false
          description: Force create even if partial records exist
        magentoAdminToken:
          type: string
          description: Magento admin API token
        stripeApiKey:
          type: string
          description: Stripe secret API key
        salesforceAccessToken:
          type: string
          description: Salesforce OAuth access token
          
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 1: Check if customer already exists in Magento
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: checkExistingCustomer
        description: Check if customer email already exists in Magento
        operationId: magentoApi.searchCustomers
        parameters:
          - name: searchCriteria[filterGroups][0][filters][0][field]
            in: query
            value: email
          - name: searchCriteria[filterGroups][0][filters][0][value]
            in: query
            value: \$inputs.email
          - name: searchCriteria[filterGroups][0][filters][0][conditionType]
            in: query
            value: eq
          - name: Authorization
            in: header
            value: Bearer \$inputs.magentoAdminToken
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          customerExists: \$response.body.total_count > 0
          existingCustomerId: \$response.body.items[0].id
          existingStripeId: \$response.body.items[0].custom_attributes[?(@.attribute_code=='stripe_customer_id')].value
        
        # âš¡ Conditional branching: Skip creation if exists
        onSuccess:
          - name: customerFound
            type: goto
            stepId: syncExistingCustomer
            criteria:
              - condition: \$response.body.total_count > 0
          - name: customerNotFound
            type: goto
            stepId: createMagentoCustomer
            criteria:
              - condition: \$response.body.total_count == 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 2a: Create NEW customer in Magento
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: createMagentoCustomer
        description: Create customer account in Adobe Commerce (Magento)
        operationId: magentoApi.createCustomer
        requestBody:
          contentType: application/json
          payload:
            customer:
              email: \$inputs.email
              firstname: \$inputs.firstName
              lastname: \$inputs.lastName
              addresses:
                - telephone: \$inputs.phone
                  street: 
                    - \$inputs.billingAddress.street
                  city: \$inputs.billingAddress.city
                  postcode: \$inputs.billingAddress.postcode
                  country_id: \$inputs.billingAddress.country_id
                  default_billing: true
                  default_shipping: true
        parameters:
          - name: Authorization
            in: header
            value: Bearer \$inputs.magentoAdminToken
        
        successCriteria:
          - condition: \$statusCode == 200
          - condition: \$response.body.id != null
        
        outputs:
          magentoCustomerId: \$response.body.id
          magentoCreatedAt: \$response.body.created_at
          customerGroupId: \$response.body.group_id
          isNewCustomer: true
        
        # âš¡ onFailure: Handle 409 Conflict (customer exists race condition)
        onFailure:
          - name: handleConflict409
            type: goto
            stepId: checkExistingCustomer
            criteria:
              - condition: \$statusCode == 409
            outputs:
              retryReason: "Customer was created by another process"
          - name: handleValidation400
            type: goto
            stepId: handleValidationError
            criteria:
              - condition: \$statusCode == 400
          - name: handleServerError
            type: end
            criteria:
              - condition: \$statusCode >= 500

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 2b: Sync EXISTING customer (skip creation)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: syncExistingCustomer
        description: Retrieve existing customer details for sync
        operationId: magentoApi.getCustomer
        parameters:
          - name: customerId
            in: path
            value: \$steps.checkExistingCustomer.outputs.existingCustomerId
          - name: Authorization
            in: header
            value: Bearer \$inputs.magentoAdminToken
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          magentoCustomerId: \$response.body.id
          magentoCreatedAt: \$response.body.created_at
          customerGroupId: \$response.body.group_id
          existingStripeId: \$response.body.custom_attributes[?(@.attribute_code=='stripe_customer_id')].value
          existingSalesforceId: \$response.body.custom_attributes[?(@.attribute_code=='salesforce_contact_id')].value
          isNewCustomer: false
        
        # âš¡ Check if Stripe sync needed
        onSuccess:
          - name: needsStripeSync
            type: goto
            stepId: createStripeCustomer
            criteria:
              - condition: \$response.body.custom_attributes[?(@.attribute_code=='stripe_customer_id')].value == null
          - name: alreadySynced
            type: goto
            stepId: verifyExternalAccounts
            criteria:
              - condition: \$response.body.custom_attributes[?(@.attribute_code=='stripe_customer_id')].value != null

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 3: Create Stripe Customer (with duplicate handling)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: createStripeCustomer
        description: Create customer in Stripe for payment processing
        operationId: stripeApi.createCustomer
        requestBody:
          contentType: application/x-www-form-urlencoded
          payload:
            email: \$inputs.email
            name: \$inputs.firstName \$inputs.lastName
            phone: \$inputs.phone
            metadata[magento_customer_id]: \$steps.createMagentoCustomer.outputs.magentoCustomerId
            metadata[source]: magento_sync
            metadata[created_by]: arazzo_workflow
            address[line1]: \$inputs.billingAddress.street
            address[city]: \$inputs.billingAddress.city
            address[postal_code]: \$inputs.billingAddress.postcode
            address[country]: \$inputs.billingAddress.country_id
        parameters:
          - name: Authorization
            in: header
            value: Bearer \$inputs.stripeApiKey
          - name: Idempotency-Key
            in: header
            value: magento_\$steps.createMagentoCustomer.outputs.magentoCustomerId
        
        successCriteria:
          - condition: \$statusCode == 200
          - condition: \$response.body.id != null
        
        outputs:
          stripeCustomerId: \$response.body.id
          stripeCreatedAt: \$response.body.created
          stripeObject: \$response.body.object
        
        # âš¡ onFailure: Handle Stripe errors
        onFailure:
          - name: handleStripeConflict
            type: goto
            stepId: findExistingStripeCustomer
            criteria:
              - condition: \$statusCode == 409
          - name: handleStripeRateLimit
            type: retry
            retryAfter: 1000
            retryLimit: 3
            criteria:
              - condition: \$statusCode == 429
          - name: handleStripeError
            type: goto
            stepId: handleStripeError
            criteria:
              - condition: \$statusCode == 400

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 3b: Find existing Stripe customer (fallback)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: findExistingStripeCustomer
        description: Search for existing Stripe customer by email
        operationId: stripeApi.searchCustomers
        parameters:
          - name: query
            in: query
            value: email:'\$inputs.email'
          - name: Authorization
            in: header
            value: Bearer \$inputs.stripeApiKey
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          stripeCustomerId: \$response.body.data[0].id
          stripeCreatedAt: \$response.body.data[0].created
          customerFoundInStripe: \$response.body.data.length > 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 4: Create Salesforce Contact (with upsert logic)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: createSalesforceContact
        description: Create or update contact in Salesforce CRM
        operationId: salesforceApi.upsertContact
        parameters:
          - name: External_ID__c
            in: path
            value: \$inputs.email
        requestBody:
          contentType: application/json
          payload:
            FirstName: \$inputs.firstName
            LastName: \$inputs.lastName
            Email: \$inputs.email
            Phone: \$inputs.phone
            Account:
              Name: \$inputs.company
            MailingStreet: \$inputs.billingAddress.street
            MailingCity: \$inputs.billingAddress.city
            MailingPostalCode: \$inputs.billingAddress.postcode
            MailingCountry: \$inputs.billingAddress.country_id
            Magento_Customer_ID__c: \$steps.createMagentoCustomer.outputs.magentoCustomerId
            Stripe_Customer_ID__c: \$steps.createStripeCustomer.outputs.stripeCustomerId
            LeadSource: E-Commerce Website
            Customer_Status__c: Active
        parameters:
          - name: Authorization
            in: header
            value: Bearer \$inputs.salesforceAccessToken
        
        # âœ… Accept both 200 (update) and 201 (create)
        successCriteria:
          - condition: \$statusCode == 200 || \$statusCode == 201
        
        outputs:
          salesforceContactId: \$response.body.id
          salesforceSuccess: \$response.body.success
          wasCreated: \$statusCode == 201
          wasUpdated: \$statusCode == 200
        
        onFailure:
          - name: handleSalesforceConflict
            type: goto
            stepId: updateExistingSalesforceContact
            criteria:
              - condition: \$statusCode == 409

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 5: Update Magento with External IDs
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: updateMagentoWithExternalIds
        description: Update Magento customer with Stripe and Salesforce IDs
        operationId: magentoApi.updateCustomer
        parameters:
          - name: customerId
            in: path
            value: \$steps.createMagentoCustomer.outputs.magentoCustomerId
          - name: Authorization
            in: header
            value: Bearer \$inputs.magentoAdminToken
        requestBody:
          contentType: application/json
          payload:
            customer:
              id: \$steps.createMagentoCustomer.outputs.magentoCustomerId
              custom_attributes:
                - attribute_code: stripe_customer_id
                  value: \$steps.createStripeCustomer.outputs.stripeCustomerId
                - attribute_code: salesforce_contact_id
                  value: \$steps.createSalesforceContact.outputs.salesforceContactId
                - attribute_code: sync_status
                  value: completed
                - attribute_code: last_sync_date
                  value: "2024-12-11T10:00:00Z"
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          syncCompleted: true
          finalCustomerId: \$response.body.id

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 6: Verify all external accounts exist
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: verifyExternalAccounts
        description: Verify Stripe and Salesforce accounts exist
        operationId: stripeApi.retrieveCustomer
        parameters:
          - name: customer
            in: path
            value: \$steps.syncExistingCustomer.outputs.existingStripeId
          - name: Authorization
            in: header
            value: Bearer \$inputs.stripeApiKey
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          stripeVerified: true
          stripeCustomerId: \$response.body.id

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ERROR HANDLERS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - stepId: handleValidationError
        description: Handle validation errors
        operationId: magentoApi.logError
        requestBody:
          contentType: application/json
          payload:
            type: VALIDATION_ERROR
            source: customer_onboarding
            email: \$inputs.email
            timestamp: "2024-12-11T10:00:00Z"
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          errorLogged: true
          errorType: VALIDATION_ERROR

      - stepId: handleStripeError
        description: Handle Stripe API errors
        operationId: magentoApi.logError
        requestBody:
          contentType: application/json
          payload:
            type: STRIPE_ERROR
            source: customer_onboarding
            magentoCustomerId: \$steps.createMagentoCustomer.outputs.magentoCustomerId
            timestamp: "2024-12-11T10:00:00Z"
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          errorLogged: true
          errorType: STRIPE_ERROR

      - stepId: updateExistingSalesforceContact
        description: Update existing Salesforce contact on conflict
        operationId: salesforceApi.updateContact
        parameters:
          - name: contactId
            in: path
            value: \$response.body.id
          - name: Authorization
            in: header
            value: Bearer \$inputs.salesforceAccessToken
        requestBody:
          contentType: application/json
          payload:
            Magento_Customer_ID__c: \$steps.createMagentoCustomer.outputs.magentoCustomerId
            Stripe_Customer_ID__c: \$steps.createStripeCustomer.outputs.stripeCustomerId
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          salesforceContactId: \$response.body.id
          salesforceSuccess: true
          wasUpdated: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # WORKFLOW OUTPUTS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    outputs:
      magentoCustomerId: \$steps.createMagentoCustomer.outputs.magentoCustomerId
      stripeCustomerId: \$steps.createStripeCustomer.outputs.stripeCustomerId
      salesforceContactId: \$steps.createSalesforceContact.outputs.salesforceContactId
      isNewCustomer: \$steps.createMagentoCustomer.outputs.isNewCustomer
      syncCompleted: \$steps.updateMagentoWithExternalIds.outputs.syncCompleted
      onboardingStatus: success
      
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WORKFLOW 2: Order Processing with Payment Error Handling
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - workflowId: order-processing-advanced
    summary: Order Processing & Payment Flow with Error Recovery
    description: |
      Processes orders with comprehensive error handling:
      âš¡ 404 handling for missing orders
      âš¡ Payment decline recovery (402)
      âš¡ Idempotent payment creation
      âš¡ Rollback on partial failures
    
    inputs:
      type: object
      required: [magentoOrderId]
      properties:
        magentoOrderId:
          type: string
          pattern: "^[0-9]{9}\$"
          description: Magento order increment ID
        retryPayment:
          type: boolean
          default: false
          description: Retry previously failed payment
        magentoAdminToken:
          type: string
        stripeApiKey:
          type: string
        salesforceAccessToken:
          type: string
          
    steps:
      - stepId: getOrderDetails
        description: Retrieve order details from Magento
        operationId: magentoApi.getOrder
        parameters:
          - name: orderId
            in: path
            value: \$inputs.magentoOrderId
          - name: Authorization
            in: header
            value: Bearer \$inputs.magentoAdminToken
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          orderIncrementId: \$response.body.increment_id
          orderGrandTotal: \$response.body.grand_total
          orderCurrency: \$response.body.order_currency_code
          customerEmail: \$response.body.customer_email
          customerId: \$response.body.customer_id
          orderStatus: \$response.body.status
          orderItems: \$response.body.items
        
        # âš¡ onFailure: Handle 404 Not Found
        onFailure:
          - name: orderNotFound
            type: end
            criteria:
              - condition: \$statusCode == 404
            outputs:
              error: "Order not found"
              errorCode: ORDER_NOT_FOUND

      - stepId: getCustomerStripeId
        description: Get Stripe customer ID from Magento customer
        operationId: magentoApi.getCustomer
        parameters:
          - name: customerId
            in: path
            value: \$steps.getOrderDetails.outputs.customerId
          - name: Authorization
            in: header
            value: Bearer \$inputs.magentoAdminToken
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          stripeCustomerId: \$response.body.custom_attributes[?(@.attribute_code=='stripe_customer_id')].value
          salesforceContactId: \$response.body.custom_attributes[?(@.attribute_code=='salesforce_contact_id')].value
          customerFirstName: \$response.body.firstname
          customerLastName: \$response.body.lastname
        
        # âš¡ Check if customer has Stripe account
        onSuccess:
          - name: hasStripeAccount
            type: goto
            stepId: createStripePaymentIntent
            criteria:
              - condition: \$response.body.custom_attributes[?(@.attribute_code=='stripe_customer_id')].value != null
          - name: noStripeAccount
            type: goto
            stepId: handleMissingStripeAccount
            criteria:
              - condition: \$response.body.custom_attributes[?(@.attribute_code=='stripe_customer_id')].value == null

      - stepId: handleMissingStripeAccount
        description: Handle case where customer has no Stripe account
        operationId: magentoApi.addOrderComment
        parameters:
          - name: orderId
            in: path
            value: \$inputs.magentoOrderId
          - name: Authorization
            in: header
            value: Bearer \$inputs.magentoAdminToken
        requestBody:
          contentType: application/json
          payload:
            statusHistory:
              comment: "Payment failed: Customer has no payment method configured"
              is_customer_notified: 1
              is_visible_on_front: 1
              status: holded
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          orderOnHold: true
          holdReason: "No Stripe account configured"

      - stepId: createStripePaymentIntent
        description: Create payment intent in Stripe
        operationId: stripeApi.createPaymentIntent
        requestBody:
          contentType: application/x-www-form-urlencoded
          payload:
            amount: \$steps.getOrderDetails.outputs.orderGrandTotal
            currency: \$steps.getOrderDetails.outputs.orderCurrency
            customer: \$steps.getCustomerStripeId.outputs.stripeCustomerId
            description: Order \$steps.getOrderDetails.outputs.orderIncrementId
            metadata[magento_order_id]: \$inputs.magentoOrderId
            metadata[magento_increment_id]: \$steps.getOrderDetails.outputs.orderIncrementId
            receipt_email: \$steps.getOrderDetails.outputs.customerEmail
            automatic_payment_methods[enabled]: true
        parameters:
          - name: Authorization
            in: header
            value: Bearer \$inputs.stripeApiKey
          - name: Idempotency-Key
            in: header
            value: order_\$inputs.magentoOrderId
        
        successCriteria:
          - condition: \$statusCode == 200
        
        outputs:
          paymentIntentId: \$response.body.id
          paymentIntentSecret: \$response.body.client_secret
          paymentStatus: \$response.body.status
          stripeAmount: \$response.body.amount
        
        # âš¡ Handle payment errors
        onFailure:
          - name: handlePaymentDeclined
            type: goto
            stepId: handlePaymentFailure
            criteria:
              - condition: \$statusCode == 402
          - name: handleStripeRateLimit
            type: retry
            retryAfter: 2000
            retryLimit: 3
            criteria:
              - condition: \$statusCode == 429

      - stepId: handlePaymentFailure
        description: Handle declined payment
        operationId: magentoApi.addOrderComment
        parameters:
          - name: orderId
            in: path
            value: \$inputs.magentoOrderId
          - name: Authorization
            in: header
            value: Bearer \$inputs.magentoAdminToken
        requestBody:
          contentType: application/json
          payload:
            statusHistory:
              comment: "Payment declined by Stripe. Please update payment method."
              is_customer_notified: 1
              is_visible_on_front: 1
              status: payment_review
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          paymentFailed: true
          failureHandled: true

      - stepId: createSalesforceOpportunity
        description: Create opportunity in Salesforce CRM
        operationId: salesforceApi.createOpportunity
        requestBody:
          contentType: application/json
          payload:
            Name: Order \$steps.getOrderDetails.outputs.orderIncrementId
            Amount: \$steps.getOrderDetails.outputs.orderGrandTotal
            StageName: Closed Won
            ContactId: \$steps.getCustomerStripeId.outputs.salesforceContactId
            Type: New Business
            LeadSource: Web
            Description: E-commerce order from Magento
            Magento_Order_ID__c: \$steps.getOrderDetails.outputs.orderIncrementId
            Stripe_Payment_Intent__c: \$steps.createStripePaymentIntent.outputs.paymentIntentId
        parameters:
          - name: Authorization
            in: header
            value: Bearer \$inputs.salesforceAccessToken
        
        successCriteria:
          - condition: \$statusCode == 201
        
        outputs:
          opportunityId: \$response.body.id
          opportunitySuccess: \$response.body.success

      - stepId: updateMagentoOrderPayment
        description: Update Magento order with Stripe payment reference
        operationId: magentoApi.addOrderComment
        parameters:
          - name: orderId
            in: path
            value: \$inputs.magentoOrderId
          - name: Authorization
            in: header
            value: Bearer \$inputs.magentoAdminToken
        requestBody:
          contentType: application/json
          payload:
            statusHistory:
              comment: Payment Intent created - Stripe ID \$steps.createStripePaymentIntent.outputs.paymentIntentId | Salesforce Opportunity \$steps.createSalesforceOpportunity.outputs.opportunityId
              is_customer_notified: 0
              is_visible_on_front: 0
              status: processing
        successCriteria:
          - condition: \$statusCode == 200
        outputs:
          orderUpdateSuccess: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # WORKFLOW OUTPUTS  
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    outputs:
      orderId: \$steps.getOrderDetails.outputs.orderIncrementId
      orderTotal: \$steps.getOrderDetails.outputs.orderGrandTotal
      paymentIntentId: \$steps.createStripePaymentIntent.outputs.paymentIntentId
      paymentClientSecret: \$steps.createStripePaymentIntent.outputs.paymentIntentSecret
      salesforceOpportunityId: \$steps.createSalesforceOpportunity.outputs.opportunityId
      processingStatus: success`;

        function loadExample() {
            document.getElementById('arazzo-input').value = exampleSpec;
            showMessage('ğŸ¾ Pet Store Advanced example loaded! Features: onSuccess/onFailure, 409 handling, step skip, JSON schemas', 'success');
        }

        function loadEcommerceExample() {
            document.getElementById('arazzo-input').value = ecommerceExampleSpec;
            showMessage('ğŸ›’ E-Commerce Advanced example loaded! Features: 409 "customer exists" handling, conditional branching, error recovery', 'success');
        }

        function clearInput() {
            document.getElementById('arazzo-input').value = '';
            document.getElementById('visualization-wrapper').style.display = 'none';
            document.getElementById('message-container').innerHTML = '';
        }

        function showMessage(text, type) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="${type}-message">${text}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function visualize() {
            const input = document.getElementById('arazzo-input').value.trim();
            
            if (!input) {
                showMessage('Please enter an Arazzo specification', 'error');
                return;
            }

            try {
                // Try parsing as YAML first, then JSON
                let spec;
                try {
                    spec = jsyaml.load(input);
                } catch (e) {
                    spec = JSON.parse(input);
                }

                // Validate basic structure
                if (!spec.arazzo || !spec.workflows) {
                    throw new Error('Invalid Arazzo specification: missing required fields');
                }

                currentSpec = spec;
                
                // Populate workflow selector
                const selector = document.getElementById('workflow-selector');
                selector.innerHTML = spec.workflows.map(w => 
                    `<option value="${w.workflowId}">${w.workflowId} - ${w.summary || ''}</option>`
                ).join('');

                currentWorkflow = spec.workflows[0];
                
                // Update info panel
                updateInfoPanel(spec);
                
                // Generate visualizations
                generateMermaidDiagram();
                generateReactFlow();
                generateDataFlowView();
                
                document.getElementById('visualization-wrapper').style.display = 'block';
                showMessage('Specification parsed and visualized successfully!', 'success');
                
            } catch (error) {
                showMessage(`Error parsing specification: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function selectWorkflow() {
            const workflowId = document.getElementById('workflow-selector').value;
            currentWorkflow = currentSpec.workflows.find(w => w.workflowId === workflowId);
            generateMermaidDiagram();
            generateReactFlow();
            generateDataFlowView();
        }

        function updateInfoPanel(spec) {
            const grid = document.getElementById('info-grid');
            grid.innerHTML = `
                <div class="info-card">
                    <div class="info-card-label">Title</div>
                    <div class="info-card-value">${spec.info.title}</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Version</div>
                    <div class="info-card-value">${spec.info.version}</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Arazzo Version</div>
                    <div class="info-card-value">${spec.arazzo}</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Workflows</div>
                    <div class="info-card-value">${spec.workflows.length}</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Source Descriptions</div>
                    <div class="info-card-value">${spec.sourceDescriptions?.length || 0}</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Total Steps</div>
                    <div class="info-card-value">${spec.workflows.reduce((acc, w) => acc + (w.steps?.length || 0), 0)}</div>
                </div>
            `;
        }

        function generateMermaidDiagram() {
            if (!currentWorkflow) return;

            const workflow = currentWorkflow;
            let mermaidCode = 'flowchart TD\n';
            mermaidCode += '    classDef inputNode fill:#22543d,stroke:#48bb78,color:#fff\n';
            mermaidCode += '    classDef stepNode fill:#2c5282,stroke:#4299e1,color:#fff\n';
            mermaidCode += '    classDef outputNode fill:#9c4221,stroke:#ed8936,color:#fff\n\n';

            // Add input node
            const inputProps = workflow.inputs?.properties ? Object.keys(workflow.inputs.properties).join(', ') : 'inputs';
            mermaidCode += `    INPUT[/"ğŸ”¹ INPUTS\\n${inputProps}"/]:::inputNode\n`;

            // Add step nodes
            workflow.steps.forEach((step, index) => {
                const desc = step.description || step.operationId || step.stepId;
                const shortDesc = desc.length > 30 ? desc.substring(0, 30) + '...' : desc;
                mermaidCode += `    ${step.stepId}["ğŸ“Œ ${step.stepId}\\n${shortDesc}"]:::stepNode\n`;
            });

            // Add output node
            if (workflow.outputs) {
                const outputProps = Object.keys(workflow.outputs).join(', ');
                mermaidCode += `    OUTPUT[/"ğŸ”¸ OUTPUTS\\n${outputProps}"/]:::outputNode\n`;
            }

            // Add edges
            mermaidCode += '\n';
            
            // Input to first step
            if (workflow.steps.length > 0) {
                mermaidCode += `    INPUT --> ${workflow.steps[0].stepId}\n`;
            }

            // Step to step connections
            for (let i = 0; i < workflow.steps.length - 1; i++) {
                mermaidCode += `    ${workflow.steps[i].stepId} --> ${workflow.steps[i + 1].stepId}\n`;
            }

            // Last step to output
            if (workflow.outputs && workflow.steps.length > 0) {
                mermaidCode += `    ${workflow.steps[workflow.steps.length - 1].stepId} --> OUTPUT\n`;
            }

            // Add data flow annotations based on expressions
            workflow.steps.forEach(step => {
                if (step.parameters) {
                    step.parameters.forEach(param => {
                        if (param.value && typeof param.value === 'string') {
                            const stepMatch = param.value.match(/\$steps\.(\w+)/);
                            if (stepMatch) {
                                const sourceStep = stepMatch[1];
                                mermaidCode += `    ${sourceStep} -.->|"${param.name}"| ${step.stepId}\n`;
                            }
                        }
                    });
                }
            });

            // Render Mermaid diagram
            const container = document.getElementById('mermaid-diagram');
            container.innerHTML = '';
            
            mermaid.render('mermaid-svg', mermaidCode).then(result => {
                container.innerHTML = result.svg;
            }).catch(error => {
                container.innerHTML = `<div style="color: red; padding: 20px;">Error rendering diagram: ${error.message}</div>`;
                console.error('Mermaid error:', error);
            });
        }

        function generateReactFlow() {
            if (!currentWorkflow) return;

            const workflow = currentWorkflow;
            const nodesContainer = document.getElementById('rf-nodes');
            const edgesSvg = document.getElementById('rf-edges');
            
            nodesContainer.innerHTML = '';
            edgesSvg.innerHTML = '';

            const nodes = [];
            const edges = [];
            
            const startX = 100;
            const startY = 50;
            const nodeWidth = 220;
            const nodeHeight = 80;
            const verticalGap = 120;

            // Create input node
            const inputNode = {
                id: 'input',
                x: startX + 200,
                y: startY,
                type: 'input',
                data: {
                    label: 'INPUTS',
                    content: workflow.inputs?.properties ? Object.keys(workflow.inputs.properties).join(', ') : 'inputs'
                }
            };
            nodes.push(inputNode);

            // Create step nodes
            workflow.steps.forEach((step, index) => {
                const node = {
                    id: step.stepId,
                    x: startX + 200,
                    y: startY + (index + 1) * verticalGap,
                    type: 'step',
                    data: {
                        label: step.stepId,
                        description: step.description || '',
                        operationId: step.operationId || '',
                        outputs: step.outputs ? Object.keys(step.outputs) : []
                    }
                };
                nodes.push(node);

                // Edge from previous node
                const sourceId = index === 0 ? 'input' : workflow.steps[index - 1].stepId;
                edges.push({
                    id: `e-${sourceId}-${step.stepId}`,
                    source: sourceId,
                    target: step.stepId
                });
            });

            // Create output node
            if (workflow.outputs) {
                const outputNode = {
                    id: 'output',
                    x: startX + 200,
                    y: startY + (workflow.steps.length + 1) * verticalGap,
                    type: 'output',
                    data: {
                        label: 'OUTPUTS',
                        content: Object.keys(workflow.outputs).join(', ')
                    }
                };
                nodes.push(outputNode);

                if (workflow.steps.length > 0) {
                    edges.push({
                        id: `e-${workflow.steps[workflow.steps.length - 1].stepId}-output`,
                        source: workflow.steps[workflow.steps.length - 1].stepId,
                        target: 'output'
                    });
                }
            }

            // Render nodes
            nodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = `rf-node ${node.type}-node`;
                nodeEl.id = `node-${node.id}`;
                nodeEl.style.left = `${node.x}px`;
                nodeEl.style.top = `${node.y}px`;
                
                let content = '';
                if (node.type === 'input') {
                    content = `
                        <div class="rf-node-header">
                            <span class="rf-node-badge" style="background: #48bb78;">INPUT</span>
                            ${node.data.label}
                        </div>
                        <div class="rf-node-content">${node.data.content}</div>
                    `;
                } else if (node.type === 'output') {
                    content = `
                        <div class="rf-node-header">
                            <span class="rf-node-badge" style="background: #ed8936;">OUTPUT</span>
                            ${node.data.label}
                        </div>
                        <div class="rf-node-content">${node.data.content}</div>
                    `;
                } else {
                    const method = extractMethod(node.data.operationId);
                    content = `
                        <div class="rf-node-header">
                            <span class="rf-node-badge" style="background: #4299e1;">STEP</span>
                            ${node.data.label}
                        </div>
                        <div class="rf-node-content">
                            ${method ? `<span class="rf-node-method ${method.toLowerCase()}">${method}</span>` : ''}
                            ${node.data.description.substring(0, 40)}${node.data.description.length > 40 ? '...' : ''}
                        </div>
                    `;
                }
                
                nodeEl.innerHTML = content;
                
                // Make nodes draggable
                makeDraggable(nodeEl, node);
                
                nodesContainer.appendChild(nodeEl);
            });

            // Store nodes for edge drawing
            window.rfNodes = nodes;
            window.rfEdges = edges;
            
            // Draw edges
            drawEdges();
        }

        function generateDataFlowView() {
            if (!currentWorkflow) return;

            const workflow = currentWorkflow;
            const container = document.getElementById('dataflow-container');
            
            // Parse all expressions to build dependency map
            const dependencyMap = buildDependencyMap(workflow);
            
            let html = `
                <div class="df-workflow-header">
                    <h2>ğŸ“Š ${workflow.workflowId}</h2>
                    <p>${workflow.description || workflow.summary || ''}</p>
                </div>

                <div class="df-legend">
                    <div class="df-legend-item">
                        <div class="df-legend-color" style="background: #48bb78;"></div>
                        Input Fields
                    </div>
                    <div class="df-legend-item">
                        <div class="df-legend-color" style="background: #ed8936;"></div>
                        Output Fields
                    </div>
                    <div class="df-legend-item">
                        <div class="df-legend-color" style="background: #9f7aea;"></div>
                        Parameters
                    </div>
                    <div class="df-legend-item">
                        <div class="df-legend-line" style="background: linear-gradient(90deg, #48bb78, #00d9ff);"></div>
                        Data Flow Link
                    </div>
                </div>

                <div class="df-steps-container">
            `;

            // Workflow Inputs Card
            if (workflow.inputs?.properties) {
                html += `
                    <div class="df-step-card input-card">
                        <div class="df-step-header">
                            <span class="df-step-badge">WORKFLOW</span>
                            <span class="df-step-title">Inputs</span>
                        </div>
                        <div class="df-step-body">
                            <div class="df-fields-section">
                                <div class="df-fields-label outputs">Available Input Fields</div>
                                ${Object.entries(workflow.inputs.properties).map(([name, prop]) => `
                                    <div class="df-field output-field" data-field-id="inputs.${name}">
                                        <div class="df-field-name">$inputs.${name}</div>
                                        <div class="df-field-value">
                                            Type: ${prop.type || 'any'}
                                            ${prop.default !== undefined ? ` | Default: ${prop.default}` : ''}
                                            ${prop.description ? `<br>${prop.description}` : ''}
                                        </div>
                                        ${getUsageInfo('inputs', name, dependencyMap)}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="df-divider"><span class="df-divider-icon">â¬‡ï¸</span></div>
                `;
            }

            // Step Cards
            workflow.steps.forEach((step, index) => {
                const usedExpressions = extractExpressions(step);
                const method = extractMethod(step.operationId);
                
                html += `
                    <div class="df-step-card">
                        <div class="df-step-header">
                            <span class="df-step-badge">STEP ${index + 1}</span>
                            <span class="df-step-title">${step.stepId}</span>
                            ${method ? `<span class="rf-node-method ${method.toLowerCase()}">${method}</span>` : ''}
                            <span class="df-step-desc">${step.description || ''}</span>
                        </div>
                        <div class="df-step-body">
                            <div class="df-fields-section">
                                <div class="df-fields-label inputs">Inputs (Parameters & Body)</div>
                                ${renderStepInputs(step, usedExpressions)}
                            </div>
                            ${step.outputs ? `
                                <div class="df-fields-section">
                                    <div class="df-fields-label outputs">Outputs</div>
                                    ${Object.entries(step.outputs).map(([name, expr]) => `
                                        <div class="df-field output-field" data-field-id="steps.${step.stepId}.outputs.${name}">
                                            <div class="df-field-name">${name}</div>
                                            <div class="df-field-value">
                                                <span class="df-expression-highlight">${expr}</span>
                                            </div>
                                            ${getUsageInfo('steps.' + step.stepId + '.outputs', name, dependencyMap)}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                if (index < workflow.steps.length - 1 || workflow.outputs) {
                    html += `<div class="df-divider"><span class="df-divider-icon">â¬‡ï¸</span></div>`;
                }
            });

            // Workflow Outputs Card
            if (workflow.outputs) {
                html += `
                    <div class="df-step-card output-card">
                        <div class="df-step-header">
                            <span class="df-step-badge">WORKFLOW</span>
                            <span class="df-step-title">Outputs</span>
                        </div>
                        <div class="df-step-body">
                            <div class="df-fields-section">
                                <div class="df-fields-label inputs">Final Output Values</div>
                                ${Object.entries(workflow.outputs).map(([name, expr]) => `
                                    <div class="df-field input-field">
                                        <div class="df-field-name">${name}</div>
                                        <div class="df-field-value">
                                            <span class="df-expression-highlight">${expr}</span>
                                            ${renderSourceLink(expr)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            
            container.innerHTML = html;
        }

        function buildDependencyMap(workflow) {
            const map = {};
            
            // Track where each output is used
            workflow.steps.forEach(step => {
                const expressions = extractExpressions(step);
                expressions.forEach(expr => {
                    const match = expr.match(/\$(inputs|steps)\.([^\s\.\[]+)(?:\.outputs\.([^\s\.\[]+))?/);
                    if (match) {
                        const key = match[1] === 'inputs' 
                            ? `inputs.${match[2]}`
                            : `steps.${match[2]}.outputs.${match[3] || '*'}`;
                        if (!map[key]) map[key] = [];
                        map[key].push({ stepId: step.stepId, expression: expr });
                    }
                });
            });

            // Track workflow output usage
            if (workflow.outputs) {
                Object.entries(workflow.outputs).forEach(([name, expr]) => {
                    const match = expr.match(/\$(inputs|steps)\.([^\s\.\[]+)(?:\.outputs\.([^\s\.\[]+))?/);
                    if (match) {
                        const key = match[1] === 'inputs' 
                            ? `inputs.${match[2]}`
                            : `steps.${match[2]}.outputs.${match[3] || '*'}`;
                        if (!map[key]) map[key] = [];
                        map[key].push({ stepId: 'workflow-output', outputName: name, expression: expr });
                    }
                });
            }

            return map;
        }

        function extractExpressions(step) {
            const expressions = [];
            
            // From parameters
            if (step.parameters) {
                step.parameters.forEach(param => {
                    if (param.value && typeof param.value === 'string' && param.value.includes('$')) {
                        expressions.push(param.value);
                    }
                });
            }
            
            // From request body
            if (step.requestBody?.payload) {
                extractExpressionsFromObject(step.requestBody.payload, expressions);
            }

            return expressions;
        }

        function extractExpressionsFromObject(obj, expressions) {
            if (typeof obj === 'string' && obj.includes('$')) {
                expressions.push(obj);
            } else if (typeof obj === 'object' && obj !== null) {
                Object.values(obj).forEach(val => extractExpressionsFromObject(val, expressions));
            }
        }

        function renderStepInputs(step, usedExpressions) {
            let html = '';
            
            // Parameters
            if (step.parameters && step.parameters.length > 0) {
                step.parameters.forEach(param => {
                    const hasExpression = param.value && typeof param.value === 'string' && param.value.includes('$');
                    html += `
                        <div class="df-field param-field">
                            <div class="df-field-name">
                                ${param.name}
                                <span style="color: #888; font-weight: normal;">(${param.in})</span>
                            </div>
                            <div class="df-field-value">
                                ${hasExpression 
                                    ? `<span class="df-expression-highlight">${param.value}</span>${renderSourceLink(param.value)}`
                                    : param.value
                                }
                            </div>
                        </div>
                    `;
                });
            }
            
            // Request Body
            if (step.requestBody?.payload) {
                html += `
                    <div class="df-field param-field">
                        <div class="df-field-name">Request Body</div>
                        <div class="df-field-value">
                            ${renderPayloadFields(step.requestBody.payload)}
                        </div>
                    </div>
                `;
            }

            if (!html) {
                html = '<div class="df-field" style="color: #888;">No parameters</div>';
            }

            return html;
        }

        function renderPayloadFields(payload, indent = 0) {
            if (typeof payload !== 'object' || payload === null) {
                if (typeof payload === 'string' && payload.includes('$')) {
                    return `<span class="df-expression-highlight">${payload}</span>${renderSourceLink(payload)}`;
                }
                return String(payload);
            }

            return Object.entries(payload).map(([key, value]) => {
                const isExpr = typeof value === 'string' && value.includes('$');
                return `
                    <div style="margin-left: ${indent * 10}px; margin-top: 4px;">
                        <span style="color: #a0aec0;">${key}:</span> 
                        ${isExpr 
                            ? `<span class="df-expression-highlight">${value}</span>${renderSourceLink(value)}`
                            : (typeof value === 'object' ? renderPayloadFields(value, indent + 1) : value)
                        }
                    </div>
                `;
            }).join('');
        }

        function renderSourceLink(expression) {
            if (!expression || typeof expression !== 'string') return '';
            
            // Match $inputs.xxx or $steps.xxx.outputs.xxx
            const inputMatch = expression.match(/\$inputs\.(\w+)/);
            const stepMatch = expression.match(/\$steps\.(\w+)\.outputs\.(\w+)/);
            
            if (inputMatch) {
                return `<span class="df-data-pill linked" onclick="highlightSource('inputs', '${inputMatch[1]}')" title="From workflow inputs">
                    â† inputs.${inputMatch[1]}
                </span>`;
            }
            
            if (stepMatch) {
                return `<span class="df-data-pill linked" onclick="highlightSource('${stepMatch[1]}', '${stepMatch[2]}')" title="From step ${stepMatch[1]}">
                    â† ${stepMatch[1]}.${stepMatch[2]}
                </span>`;
            }
            
            return '';
        }

        function getUsageInfo(source, fieldName, dependencyMap) {
            const key = `${source}.${fieldName}`;
            const usages = dependencyMap[key];
            
            if (!usages || usages.length === 0) return '';
            
            const usageLabels = usages.map(u => {
                if (u.stepId === 'workflow-output') {
                    return `<span class="df-data-pill">â†’ output.${u.outputName}</span>`;
                }
                return `<span class="df-data-pill">â†’ ${u.stepId}</span>`;
            }).join('');
            
            return `<div style="margin-top: 6px; font-size: 0.75rem; color: #888;">Used by: ${usageLabels}</div>`;
        }

        function highlightSource(stepOrInput, fieldName) {
            // Remove previous highlights
            document.querySelectorAll('.df-field.highlighted').forEach(el => {
                el.classList.remove('highlighted');
                el.style.boxShadow = '';
                el.style.background = '';
            });

            // Find and highlight the source field
            const selector = stepOrInput === 'inputs' 
                ? `[data-field-id="inputs.${fieldName}"]`
                : `[data-field-id="steps.${stepOrInput}.outputs.${fieldName}"]`;
            
            const sourceEl = document.querySelector(selector);
            if (sourceEl) {
                sourceEl.classList.add('highlighted');
                sourceEl.style.boxShadow = '0 0 0 2px #00d9ff, 0 0 20px rgba(0, 217, 255, 0.4)';
                sourceEl.style.background = 'rgba(0, 217, 255, 0.2)';
                sourceEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                setTimeout(() => {
                    sourceEl.style.boxShadow = '';
                    sourceEl.style.background = '';
                    sourceEl.classList.remove('highlighted');
                }, 3000);
            }
        }

        function extractMethod(operationId) {
            if (!operationId) return null;
            const op = operationId.toLowerCase();
            if (op.includes('get') || op.includes('find') || op.includes('list')) return 'GET';
            if (op.includes('post') || op.includes('create') || op.includes('place')) return 'POST';
            if (op.includes('put') || op.includes('update')) return 'PUT';
            if (op.includes('delete') || op.includes('remove')) return 'DELETE';
            return null;
        }

        function drawEdges() {
            const svg = document.getElementById('rf-edges');
            svg.innerHTML = '';

            window.rfEdges.forEach(edge => {
                const sourceEl = document.getElementById(`node-${edge.source}`);
                const targetEl = document.getElementById(`node-${edge.target}`);
                
                if (!sourceEl || !targetEl) return;

                const sourceRect = sourceEl.getBoundingClientRect();
                const targetRect = targetEl.getBoundingClientRect();
                const canvasRect = document.getElementById('rf-canvas').getBoundingClientRect();

                const x1 = sourceRect.left - canvasRect.left + sourceRect.width / 2;
                const y1 = sourceRect.top - canvasRect.top + sourceRect.height;
                const x2 = targetRect.left - canvasRect.left + targetRect.width / 2;
                const y2 = targetRect.top - canvasRect.top;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midY = (y1 + y2) / 2;
                path.setAttribute('d', `M ${x1} ${y1} C ${x1} ${midY}, ${x2} ${midY}, ${x2} ${y2}`);
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke', '#4299e1');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('marker-end', 'url(#arrowhead)');

                svg.appendChild(path);
            });

            // Add arrowhead marker
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            defs.innerHTML = `
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#4299e1" />
                </marker>
            `;
            svg.insertBefore(defs, svg.firstChild);
        }

        function makeDraggable(element, node) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = parseInt(element.style.left);
                initialY = parseInt(element.style.top);
                element.style.zIndex = '100';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                element.style.left = `${initialX + dx}px`;
                element.style.top = `${initialY + dy}px`;
                
                drawEdges();
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.zIndex = '1';
                }
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.visualization-section').forEach(s => s.classList.remove('active'));
            
            if (tab === 'mermaid') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('mermaid-section').classList.add('active');
            } else if (tab === 'reactflow') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('reactflow-section').classList.add('active');
                setTimeout(drawEdges, 100);
            } else if (tab === 'dataflow') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('dataflow-section').classList.add('active');
            }
        }

        function zoomIn() {
            scale = Math.min(scale + 0.1, 2);
            applyTransform();
        }

        function zoomOut() {
            scale = Math.max(scale - 0.1, 0.5);
            applyTransform();
        }

        function resetView() {
            scale = 1;
            translateX = 0;
            translateY = 0;
            applyTransform();
        }

        function applyTransform() {
            const canvas = document.getElementById('rf-canvas');
            canvas.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
            canvas.style.transformOrigin = 'top left';
        }

        // Pan functionality
        let isPanning = false;
        let panStartX, panStartY;

        document.getElementById('rf-canvas')?.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('rf-canvas')) {
                isPanning = true;
                panStartX = e.clientX - translateX;
                panStartY = e.clientY - translateY;
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            translateX = e.clientX - panStartX;
            translateY = e.clientY - panStartY;
            applyTransform();
        });

        document.addEventListener('mouseup', () => {
            isPanning = false;
        });
    </script>
</body>
</html>
